import{a as e,p as t,r as i,x as o,i as a}from"./pb-mixin-B7EAqf7q.js";import"./es-global-bridge-D8ZcUcx_.js";import{g as r}from"./pb-i18n-Dne_FgGK.js";const s=["type","url","label","base","show"];class n extends e{static get properties(){return{type:{type:String},url:{type:String},base:{type:Boolean},show:{type:Boolean},label:{type:String},attribution:{type:String},minZoom:{type:Number,attribute:"min-zoom"},maxZoom:{type:Number,attribute:"max-zoom"},zoomOffset:{type:Number,attribute:"zoom-offset"},opacity:{type:Number},tileSize:{type:Number},id:{type:String},accessToken:{type:String,attribute:"access-token"}}}constructor(){super(),this.type="tile",this.url=null}get options(){const e={};return Object.keys(n.properties).forEach(t=>{s.indexOf(t)<0&&this[t]&&(e[t]=this[t])}),console.log("<pb-leaflet-map-layer> Options: %o",e),e}async data(){return new Promise(e=>{fetch(this.url).then(e=>e.json()).then(t=>e(t))})}}function l(e,t){try{return e.split(/\s*,\s*/).map(e=>parseInt(e,10))}catch(t){return console.error(`<pb-map-icon> Invalid size specified: ${e}`),null}}customElements.define("pb-map-layer",n);class c extends e{static get properties(){return{name:{type:String},iconUrl:{type:String,attribute:"icon-url"},iconSize:{type:Array,converter:l,attribute:"icon-size"},iconAnchor:{type:Array,converter:l,attribute:"icon-anchor"},shadowUrl:{type:String,attribute:"shadow-url"},shadowSize:{type:Array,converter:l,attribute:"shadow-size"},shadowAnchor:{type:Array,converter:l,attribute:"shadow-anchor"},popupAncor:{type:Array,converter:l,attribute:"popup-anchor"}}}constructor(){super(),this.name="default",this.type="image",this.iconUrl=null}get options(){const e={};return Object.keys(c.properties).forEach(t=>{this[t]&&(e[t]=this[t])}),console.log("<pb-map-icon> Options: %o",e),e}}customElements.define("pb-map-icon",c);class p extends(t(e)){static get properties(){return Object.assign(Object.assign({},super.properties),{},{latitude:{type:Number},longitude:{type:Number},zoom:{type:Number},crs:{type:String},fitMarkers:{type:Boolean,attribute:"fit-markers"},cluster:{type:Boolean},disableClusteringAt:{type:Number,attribute:"disable-clustering-at"},noScroll:{type:Boolean,attribute:"no-scroll"},accessToken:{type:String,attribute:"access-token"},toggle:{type:Boolean},imagesPath:{type:String,attribute:"images-path"},cssPath:{type:String,attribute:"css-path"},geoCoding:{type:Boolean,attribute:"geo-coding"},_map:{type:Object}})}constructor(){super(),this.latitude=51.505,this.longitude=-.09,this.zoom=15,this.crs="EPSG3857",this.accessToken="",this.imagesPath="../images/leaflet/",this.cssPath="../css/leaflet",this.toggle=!1,this.noScroll=!1,this.disabled=!0,this.cluster=!1,this.fitMarkers=!1,this.disableClusteringAt=null,this._icons={},this.geoCoding=!1,this._mapReady=!1,this._markerLayer=null}connectedCallback(){super.connectedCallback(),this._layers=this.querySelectorAll("pb-map-layer"),this._markers=this.querySelectorAll("pb-map-icon"),this.subscribeTo("pb-update-map",e=>{this._markerLayer&&(this._markerLayer.clearLayers(),e.detail.forEach(e=>{const t=L.marker([e.latitude,e.longitude]);e.label&&t.bindTooltip(e.label),t.addEventListener("click",()=>{this.emitTo("pb-leaflet-marker-click",{element:e})}),t.bindTooltip(e.label),this.setMarkerIcon(t),this._markerLayer.addLayer(t)}),this._fitBounds())}),this.subscribeTo("pb-update",e=>{if(!this._markerLayer)return;this._markerLayer.clearLayers();e.detail.root.querySelectorAll("pb-geolocation").forEach(e=>{const t=L.latLng(e.latitude,e.longitude),i=L.marker(t);this._markerLayer.addLayer(i),e.label&&i.bindTooltip(e.label),e.popup&&i.bindPopup(e.popup),i.addEventListener("click",()=>{this.emitTo("pb-leaflet-marker-click",{element:e})}),this.setMarkerIcon(i)}),this._fitBounds()}),this.subscribeTo("pb-geolocation",e=>{if(e.detail.coordinates){if(this.latitude=e.detail.coordinates.latitude,this.longitude=e.detail.coordinates.longitude,e.detail.clear&&this._markerLayer&&"function"==typeof this._markerLayer.clearLayers&&this._markerLayer.clearLayers(),this._hasMarker(this.latitude,this.longitude))console.log("<pb-leaflet-map> Marker already added to map");else{const t=L.marker([this.latitude,this.longitude]);t.addEventListener("click",()=>{this.emitTo("pb-leaflet-marker-click",e.detail)}),e.detail.label&&t.bindTooltip(e.detail.label),e.detail.popup&&t.bindPopup(e.detail.popup),this.setMarkerIcon(t),this._markerLayer&&"function"==typeof this._markerLayer.addLayer&&this._markerLayer.addLayer(t),e.detail.fitBounds&&this._fitBounds(),console.log("<pb-leaflet-map> added marker")}this.toggle&&(this.disabled=!1);const t=e.detail.event;this._locationChanged(this.latitude,this.longitude,e.detail.zoom,t)}})}get map(){return this._map}setMarkerIcon(e){this._icons&&this._icons.default&&e.setIcon(this._icons.default)}firstUpdated(){if(this.toggle||(this.disabled=!1),void 0!==window.L)return void this._initMap();window.ESGlobalBridge.requestAvailability();const e=i("../lib/leaflet-src.js"),t=i("../lib/leaflet.markercluster-src.js"),o=i("../lib/Control.Geocoder.min.js"),a=()=>{this.geoCoding?fetch(o,{method:"HEAD"}).then(e=>{if(e.ok)return window.ESGlobalBridge.instance.load("geocoding",o);throw new Error(`Geocoding script not available at ${o} (${e.status})`)}).then(this._initMap.bind(this)).catch(e=>{console.warn("<pb-leaflet-map> Failed to load geocoding script, initializing map without geocoding:",e),this._initMap()}):this._initMap()};window.ESGlobalBridge.instance.load("leaflet",e).then(()=>{this.cluster?window.ESGlobalBridge.instance.load("plugin",t).then(a).catch(e=>{console.warn("<pb-leaflet-map> Failed to load marker cluster plugin, initializing without clustering:",e),a()}):a()}).catch(e=>{console.error("<pb-leaflet-map> Failed to load Leaflet library:",e)})}render(){const e=i(this.cssPath);return o`
      <link rel="Stylesheet" href="${e}/leaflet.css" />
      <link rel="Stylesheet" href="${e}/MarkerCluster.Default.css" />
      ${this.geoCoding?o`<link rel="Stylesheet" href="${e}/Control.Geocoder.css" />`:null}
      <div id="map" style="height: 100%; width: 100%"></div>
    `}static get styles(){return a`
      :host {
        display: block;
      }

      :host([disabled]) {
        visibility: hidden;
      }

      .close {
        border-radius: 4px;
        background-color: #fff;
        color: inherit;
        padding: 8px;
        font-size: 18px;
        font-weight: bold;
        text-decoration: none;
        cursor: pointer;
      }
    `}_initMap(){if(this._map)return;L.Icon.Default.imagePath=i(this.imagesPath);const e=L.CRS[this.crs]||L.CRS.EPSG3857;if(this._map=L.map(this.shadowRoot.getElementById("map"),{zoom:this.zoom,center:L.latLng(this.latitude,this.longitude),crs:e}),this._configureLayers(),this._configureMarkers(),this.cluster&&"function"==typeof L.markerClusterGroup){const e={};this.disableClusteringAt&&(e.disableClusteringAtZoom=this.disableClusteringAt),this._markerLayer=L.markerClusterGroup(e)}else this._markerLayer=L.layerGroup();if(this._markerLayer.addTo(this._map),this._mapReady=!0,this.signalReady(),L.control.scale().addTo(this._map),this.toggle){let e;L.Control.CloseButton=L.Control.extend({options:{position:"topright"},onAdd:t=>(e=L.DomUtil.create("div"),e.className="close",e.innerHTML="X",L.DomEvent.on(e,"click",this._hide.bind(this)),e),onRemove:t=>{L.DomEvent.off(e,"click",this._hide.bind(this))}}),L.control.closeButton=e=>new L.Control.CloseButton(e),L.control.closeButton({position:"topright"}).addTo(this._map)}this._configureGeoCoding()}_configureGeoCoding(){if(!this.geoCoding)return;if(!L.Control||!L.Control.Geocoder)return void console.warn("<pb-leaflet-map> Geocoding library not properly loaded, skipping geocoding configuration");if(!L.Control.Geocoder.nominatim)return void console.warn("<pb-leaflet-map> Nominatim geocoder not available, skipping geocoding configuration");const e=L.Control.Geocoder.nominatim({geocodingQueryParams:{"accept-language":"en"}}),t=L.Control.geocoder({defaultMarkGeocode:!1,geocoder:e,placeholder:r("search.search"),suggestMinLength:3});t.on("markgeocode",e=>{const{geocode:t}=e,i={coordinates:{longitude:t.center.lng,latitude:t.center.lat},name:t.name,label:t.html,properties:t.properties};this.emitTo("pb-geocode",i)}),t.addTo(this._map),this._map.on("click",t=>{(t.originalEvent.ctrlKey||t.originalEvent.metaKey)&&(t.originalEvent.stopPropagation(),e.reverse(t.latlng,this._map.options.crs.scale(this._map.getZoom()),e=>{const i=e[0],o={coordinates:{longitude:t.latlng.lng,latitude:t.latlng.lat},name:i.name,label:i.html,properties:i.properties};this.emitTo("pb-geocode",o)}))})}_configureMarkers(){0!==this._markers.length&&(this._icons={},this._markers.forEach(e=>{e.iconUrl&&(this._icons[e.name]=L.icon(e.options))}))}_configureLayers(){if(0===this._layers.length)return void L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'&copy; <a href="https://www.mapbox.com/about/maps/">Mapbox</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank" rel="noopener">Improve this map</a></strong>',maxZoom:18,zoomOffset:-1,tileSize:512,accessToken:this.accessToken}).addTo(this._map);const e=L.control.layers(null,null,{collapsed:!0});this._layers.forEach(t=>{let i;if("geojson"===t.type)t.data().then(o=>{i=L.geoJSON([o]),this._addLayer(t,i,e)});else i=L.tileLayer(t.url,t.options),this._addLayer(t,i,e)}),this._layers.length>1&&e.addTo(this._map),this._layers=null}_addLayer(e,t,i){e.show&&t.addTo(this._map),e.label&&(e.base?i.addBaseLayer(t,e.label):i.addOverlay(t,e.label))}_fitBounds(){if(!this._markerLayer)return;if(!this.fitMarkers)return;const e=L.latLngBounds();let t=0;this._markerLayer.eachLayer(i=>{e.extend(i.getLatLng()),t+=1}),0===t?this._map.fitWorld():1===t?this._map.fitBounds(e,{maxZoom:this.zoom}):this._map.fitBounds(e)}_locationChanged(e,t,i,o){if(this._markerLayer&&this._map){const a=L.latLng([e,t]);this._markerLayer.eachLayer(e=>{e.getLatLng().equals(a)?(i&&!this.noScroll?(e.openTooltip(),this._map.setView(a,i)):this.cluster?this._markerLayer.zoomToShowLayer(e,()=>e.openTooltip()):(e.openTooltip(),i?this._map.setView(a,i):this._map.panTo(a)),o&&this._icons&&this._icons.active&&e.setIcon(this._icons.active)):this._icons&&this._icons.default&&e.getIcon()!==this._icons.default&&e.setIcon(this._icons.default)})}}_hasMarker(e,t){if(!this._markerLayer)return null;const i=L.latLng([e,t]);let o=null;return this._markerLayer.eachLayer(e=>{e instanceof L.Marker&&e.getLatLng().equals(i)&&(o=e)}),o}_hide(){this.disabled=!0}}customElements.define("pb-leaflet-map",p);export{p as PbLeafletMap};
