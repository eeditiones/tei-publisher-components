import{e as t,h as e}from"./pb-mixin-B7EAqf7q.js";class r{static subscribe(t,e,s,n=!1){const a=r._getChannels(e),i=document.addEventListener(t,t=>{s&&t.detail&&t.detail.key&&a.includes(t.detail.key)&&s(t,i)},{once:n})}static subscribeOnce(t,e=null){const s=r._getChannels(e);return new Promise(e=>{document.addEventListener(t,t=>{t.detail&&t.detail.key&&s.includes(t.detail.key)&&e(t)},{once:!0})})}static _getChannels(e){return null!==e&&e.length?Array.isArray(e)?e:[e]:[t]}static emit(e,r=null,s=null){const n=s||{};n.key=r||t;const a=new CustomEvent(e,{detail:n});document.dispatchEvent(a)}static ifReady(t){return Array.isArray(t)||(t=[t]),new Promise(e=>{const r=t.length;if(0===r)return void e();let s=r;t.forEach(t=>{if(t._isReady)return s-=1,void(0===s&&e());const r=t.addEventListener("pb-ready",()=>{s-=1,0===s&&(t.removeEventListener("pb-ready",r),e())})})})}}if(!window.pbEvents){window.pbEvents=r;try{const t=document.createElement("script");t.type="text/javascript",t.text='if (typeof pbEvents === "undefined") { try { pbEvents = window.pbEvents; } catch(e) {} }',(document.head||document.documentElement).appendChild(t)}catch(t){}}var s,n={};function a(){if(s)return n;s=1,Object.defineProperty(n,"__esModule",{value:!0}),n.PathError=n.TokenData=void 0,n.parse=u,n.compile=p,n.match=m,n.pathToRegexp=g,n.stringify=S;const t="/",e=t=>t,r=/^[$_\p{ID_Start}]$/u,a=/^[$\u200c\u200d\p{ID_Continue}]$/u,i={"{":"{","}":"}","(":"(",")":")","[":"[","]":"]","+":"+","?":"?","!":"!"};function o(t){return t.replace(/[{}()\[\]+?!:*\\]/g,"\\$&")}function h(t){return t.replace(/[.+*?^${}()[\]|/\\]/g,"\\$&")}class l{constructor(t,e){this.tokens=t,this.originalPath=e}}n.TokenData=l;class c extends TypeError{constructor(t,e){let r=t;e&&(r+=`: ${e}`),r+="; visit https://git.new/pathToRegexpError for info",super(r),this.originalPath=e}}function u(t,s={}){const{encodePath:n=e}=s,o=[...t],h=[];let u=0,p=0;function d(){let e="";if(r.test(o[u]))do{e+=o[u++]}while(a.test(o[u]));else if('"'===o[u]){let r=u;for(;u++<o.length;){if('"'===o[u]){u++,r=0;break}"\\"===o[u]&&u++,e+=o[u]}if(r)throw new c(`Unterminated quote at index ${r}`,t)}if(!e)throw new c(`Missing parameter name at index ${u}`,t);return e}for(;u<o.length;){const t=o[u],e=i[t];e?h.push({type:e,index:u++,value:t}):"\\"===t?h.push({type:"escape",index:u++,value:o[u++]}):":"===t?h.push({type:"param",index:u++,value:d()}):"*"===t?h.push({type:"wildcard",index:u++,value:d()}):h.push({type:"char",index:u++,value:t})}function f(e){const r=[];for(;;){const s=h[p++];if(s.type===e)break;if("char"===s.type||"escape"===s.type){let t=s.value,e=h[p];for(;"char"===e.type||"escape"===e.type;)t+=e.value,e=h[++p];r.push({type:"text",value:n(t)});continue}if("param"!==s.type&&"wildcard"!==s.type){if("{"!==s.type)throw new c(`Unexpected ${s.type} at index ${s.index}, expected ${e}`,t);r.push({type:"group",tokens:f("}")})}else r.push({type:s.type,name:s.value})}return r}return h.push({type:"end",index:u,value:""}),new l(f("end"),t)}function p(e,r={}){const{encode:s=encodeURIComponent,delimiter:n=t}=r,a=d(("object"==typeof e?e:u(e,r)).tokens,n,s);return function(t={}){const[e,...r]=a(t);if(r.length)throw new TypeError(`Missing parameters: ${r.join(", ")}`);return e}}function d(t,e,r){const s=t.map(t=>f(t,e,r));return t=>{const e=[""];for(const r of s){const[s,...n]=r(t);e[0]+=s,e.push(...n)}return e}}function f(t,r,s){if("text"===t.type)return()=>[t.value];if("group"===t.type){const e=d(t.tokens,r,s);return t=>{const[r,...s]=e(t);return s.length?[""]:[r]}}const n=s||e;return"wildcard"===t.type&&!1!==s?e=>{const s=e[t.name];if(null==s)return["",t.name];if(!Array.isArray(s)||0===s.length)throw new TypeError(`Expected "${t.name}" to be a non-empty array`);return[s.map((e,r)=>{if("string"!=typeof e)throw new TypeError(`Expected "${t.name}/${r}" to be a string`);return n(e)}).join(r)]}:e=>{const r=e[t.name];if(null==r)return["",t.name];if("string"!=typeof r)throw new TypeError(`Expected "${t.name}" to be a string`);return[n(r)]}}function m(r,s={}){const{decode:n=decodeURIComponent,delimiter:a=t}=s,{regexp:i,keys:o}=g(r,s),h=o.map(t=>!1===n?e:"param"===t.type?n:t=>t.split(a).map(n));return function(t){const e=i.exec(t);if(!e)return!1;const r=e[0],s=Object.create(null);for(let t=1;t<e.length;t++){if(void 0===e[t])continue;const r=o[t-1],n=h[t-1];s[r.name]=n(e[t])}return{path:r,params:s}}}function g(e,r={}){const{delimiter:s=t,end:n=!0,sensitive:a=!1,trailing:i=!0}=r,o=[],l=a?"":"i",c=[];for(const t of y(e,[])){const e="object"==typeof t?t:u(t,r);for(const t of w(e.tokens,0,[]))c.push(P(t,s,o,e.originalPath))}let p=`^(?:${c.join("|")})`;i&&(p+=`(?:${h(s)}$)?`),p+=n?"$":`(?=${h(s)}|$)`;return{regexp:new RegExp(p,l),keys:o}}function y(t,e){if(Array.isArray(t))for(const r of t)y(r,e);else e.push(t);return e}function*w(t,e,r){if(e===t.length)return yield r;const s=t[e];if("group"===s.type)for(const n of w(s.tokens,0,r.slice()))yield*w(t,e+1,n);else r.push(s);yield*w(t,e+1,r)}function P(t,e,r,s){let n="",a="",i=!0;for(const o of t)if("text"!==o.type)if("param"!==o.type&&"wildcard"!==o.type);else{if(!i&&!a)throw new c(`Missing text before "${o.name}" ${o.type}`,s);"param"===o.type?n+=`(${v(e,i?"":a)}+)`:n+="([\\s\\S]+)",r.push(o),a="",i=!1}else n+=h(o.value),a+=o.value,i||(i=o.value.includes(e));return n}function v(t,e){return e.length<2?t.length<2?`[^${h(t+e)}]`:`(?:(?!${h(t)})[^${h(e)}])`:t.length<2?`(?:(?!${h(e)})[^${h(t)}])`:`(?:(?!${h(e)}|${h(t)})[\\s\\S])`}function b(t){let e="",r=0;function s(e){return $(e)&&E(t[r])?e:JSON.stringify(e)}for(;r<t.length;){const n=t[r++];if("text"!==n.type)if("group"!==n.type)if("param"!==n.type){if("wildcard"!==n.type)throw new TypeError(`Unknown token type: ${n.type}`);e+=`*${s(n.name)}`}else e+=`:${s(n.name)}`;else e+=`{${b(n.tokens)}}`;else e+=o(n.value)}return e}function S(t){return b(t.tokens)}function $(t){const[e,...s]=t;return r.test(e)&&s.every(t=>a.test(t))}function E(t){return!t||"text"!==t.type||!a.test(t.value[0])}return n.PathError=c,n}var i=a();function o(t){if(!t)return t;let e=t.replace(/:([a-zA-Z_][a-zA-Z0-9_]*)\?/g,"{:$1}");return e=e.replace(/\*$/g,"*path"),e}function h(...t){t[0]=`%c<registry>%c ${t[0]}`,t.splice(1,0,"font-weight: bold; color: #99FF33;","color: inherit; font-weight: normal"),console.log.apply(null,t)}class l{constructor(){this.rootPath="",this.usePath=!1,this.state={},this.channelStates={},this.hash=null,this.idHash=!0,this._listeners=[],this.urlPattern=null,this.urlIgnore=new Set,this.pathParams=new Set,this.currentUser=null}configure(t=!0,e=!1,s="",n,a){if(this.rootPath=s,this.usePath=t,this.idHash=e,this.urlPattern=n,a&&a.split(/\s*,\s*/).forEach(t=>this.urlIgnore.add(t)),this.urlPattern){const t=o(this.urlPattern),e=[];i.pathToRegexp(t,e),e.forEach(t=>this.pathParams.add(t.name)),this._decodePath=i.match(t),this._encodePath=i.compile(t)}const l=this._stateFromURL();l?this.state=l:console.error("<registry> failed to parse URL: %s using template %s",window.location,this.urlTemplate),window.history.replaceState(null,""),window.addEventListener("popstate",t=>{if(t.state){try{this.channelStates=JSON.parse(t.state)}catch(t){return void console.error("<registry> error restoring state: %s",t.toString())}this.state=this._stateFromURL(),h("popstate: %o",this.channelStates),this._listeners.forEach(t=>{t.callback(this.getState(t.component))}),r.emit("pb-popstate",null,this.channelStates)}})}subscribe(t,e){this._listeners.push({component:t,callback:e})}_stateFromURL(){const t={};this.hash=window.location.hash,this.idHash&&this.hash.length>0&&!/^#\d+\./.test(this.hash)&&(t.id=this.hash.substring(1));const e=window.location.pathname.replace(new RegExp(`^${this.rootPath}/?`),"");if(this.urlPattern){const r=this._decodePath(e);Object.assign(t,r.params),h("decoded path %s using template %s: %o",e,this.urlPattern,t)}else this.usePath&&(t.path=e);const r=new URLSearchParams(window.location.search);return r.forEach((e,s)=>{if(this.urlPattern&&this.pathParams.has(s)||this.usePath&&"path"===s)return void console.warn("Found path parameter in query, but usePath is set to true. The path parameter will be ignored.");if(s in t)return;const n=r.getAll(s);1===n.length?t[s]=e:t[s]=n}),t}getState(t){const r=e(t)[0],s=this.channelStates[r];return s||(this.channelStates[r]={},this.channelStates[r])}setState(t,r){const s=e(t)[0];this.channelStates[s]=Object.assign(this.channelStates[s],r)}clearParametersMatching(t,e){const{state:r}=this;for(const t of Object.keys(r))e.test(t)&&(r[t]=null)}get(t,e){if(!this.state)return;return t.split(".").reduce((t,e)=>{if(t[e])return t[e]},this.state)||e}set(t,e){if(!t.includes("."))return void(this.state[t]=e);const r=t.split("."),s=r.pop();r.reduce((t,e)=>(t[e]||(t[e]={}),t[e]),this.state)[s]=e}commit(t,e,r=!1){if(e&&"root"in e&&null===e.root){var s,n;const a=(null==t||null===(s=t.tagName)||void 0===s?void 0:s.toLowerCase())||(null==t||null===(n=t.constructor)||void 0===n?void 0:n.name)||"unknown";console.warn("[registry] commit called with root=null by:",a,{newState:e,overwrite:r,stack:(new Error).stack})}this._commit(t,e,r,!1)}replace(t,e,r=!1){var s,n;const a=(null==t||null===(s=t.tagName)||void 0===s?void 0:s.toLowerCase())||(null==t||null===(n=t.constructor)||void 0===n?void 0:n.name)||"unknown";console.warn("[registry] replace called by:",a,{newState:e,overwrite:r,stack:(new Error).stack}),this._commit(t,e,r,!0)}_commit(t,r,s,n){const a=Object.assign({},this.state);this.state=s?r:Object.assign(Object.assign({},this.state),r);const i=this.urlFromState();console.log("[registry] _commit: committing state",{oldState:a,newState:r,overwrite:s,replace:n,mergedState:this.state,resolvedUrl:i.toString(),resolvedHash:i.hash,resolvedSearch:i.search});e(t).forEach(t=>{s||!this.channelStates[t]?this.channelStates[t]=r:Object.assign(this.channelStates[t],r)});const o=this.toJSON();n?(window.history.replaceState(o,"",i),h("replace %s: %o %d",i.toString(),this.channelStates,window.history.length),console.log("[registry] _commit: replaced URL",{url:i.toString(),hash:i.hash,search:i.search})):(window.history.pushState(o,"",i),h("commit %s: %o %d",i.toString(),this.channelStates,window.history.length),console.log("[registry] _commit: pushed URL",{url:i.toString(),hash:i.hash,search:i.search}))}urlFromState(){const t=new URL(window.location.href);function e(e,r){if(null===e)t.searchParams.delete(r);else if(Array.isArray(e)){const s=Array.from(e);t.searchParams.set(r,s.pop()),s.forEach(e=>t.searchParams.append(r,e))}else t.searchParams.set(r,e)}console.log("[registry] urlFromState: building URL from state",{state:this.state,idHash:this.idHash,usePath:this.usePath,urlPattern:this.urlPattern,urlIgnore:Array.from(this.urlIgnore),pathParams:Array.from(this.pathParams)});for(const[t,r]of Object.entries(this.state))if(this.urlPattern){const s=t.replace(/^(?:user\.)?(.*)$/,"$1"),n=this.pathParams.has(s)||this.urlIgnore.has(s);console.log("[registry] urlFromState: processing param (urlPattern)",{param:t,normParam:s,value:r,shouldIgnore:n,willInclude:!n}),n||e(r,s)}else if("path"===t&&this.usePath||this.urlIgnore.has(t))console.log("[registry] urlFromState: skipping param",{param:t,value:r,reason:"path"===t&&this.usePath?"path param with usePath=true":"in urlIgnore"});else{const s=!("path"===t&&this.usePath||this.urlIgnore.has(t)),n="view"===t&&"single"===r||"odd"===t&&"teipublisher"===r||"panels"===t&&"string"==typeof r&&r.split(".").length>10;console.log("[registry] urlFromState: processing param (no urlPattern)",{param:t,value:r,willInclude:s,isUnwantedDefault:n,isPath:"path"===t,usePath:this.usePath,inUrlIgnore:this.urlIgnore.has(t)}),s&&!n?e(r,t):n&&console.log("[registry] urlFromState: filtering out unwanted default value",{param:t,value:r,reason:"unwanted default"})}if(this.state.path&&this.state.path.length>0)if(this.urlPattern){const e={};for(const[t,r]of Object.entries(this.state))this.pathParams.has(t)&&""===r?e[t]=null:e[t]=r;const r=this._encodePath(e);t.pathname=`${this.rootPath}/${r}`}else this.usePath&&(t.pathname=`${this.rootPath}/${this.state.path}`);return this.state.id&&!this.urlPattern&&(t.hash=`#${this.state.id}`,console.log("[registry] urlFromState: set hash from state.id",{id:this.state.id,hash:t.hash})),console.log("[registry] urlFromState: final URL",{url:t.toString(),search:t.search,hash:t.hash,hasIdParam:t.searchParams.has("id"),idParamValue:t.searchParams.get("id"),hasRootParam:t.searchParams.has("root"),rootParamValue:t.searchParams.get("root")}),t}toJSON(){return JSON.stringify(this.channelStates)}}const c=new l;if("undefined"!=typeof window){window.pbRegistry||(window.pbRegistry=c),window.PB||(window.PB={});try{const t=Object.getOwnPropertyDescriptor(window.PB,"pbRegistry");t&&"function"==typeof t.get||Object.defineProperty(window.PB,"pbRegistry",{configurable:!0,enumerable:!0,get:()=>window.pbRegistry,set(t){window.pbRegistry=t}})}catch(t){window.PB.pbRegistry||(window.PB.pbRegistry=window.pbRegistry)}}export{c as r};
